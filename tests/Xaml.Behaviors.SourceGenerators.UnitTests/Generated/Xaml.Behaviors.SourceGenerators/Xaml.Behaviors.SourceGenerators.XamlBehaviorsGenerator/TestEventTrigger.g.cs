// <auto-generated />
#nullable enable
using System;
using Avalonia;
using Avalonia.Xaml.Interactivity;
using Avalonia.Controls;

namespace Avalonia.Xaml.Behaviors.SourceGenerators.UnitTests
{
    public partial class TestEventTrigger : Avalonia.Xaml.Interactivity.StyledElementTrigger
    {
        public static readonly StyledProperty<object?> SourceObjectProperty =
            AvaloniaProperty.Register<TestEventTrigger, object?>(nameof(SourceObject));

        public object? SourceObject
        {
            get => GetValue(SourceObjectProperty);
            set => SetValue(SourceObjectProperty, value);
        }

        private EventProxy? _proxy;
        private object? _resolvedSource;

        protected override void OnAttached()
        {
            base.OnAttached();
            UpdateSource();
        }

        protected override void OnDetaching()
        {
            base.OnDetaching();
            if (_resolvedSource is not null)
            {
                 UnregisterEvent(_resolvedSource);
                 _resolvedSource = null;
            }
        }

        protected override void OnPropertyChanged(AvaloniaPropertyChangedEventArgs change)
        {
            base.OnPropertyChanged(change);
            if (change.Property == SourceObjectProperty)
            {
                UpdateSource();
            }
        }

        private void UpdateSource()
        {
            var newSource = SourceObject ?? AssociatedObject;
            if (newSource != _resolvedSource)
            {
                if (_resolvedSource is not null) UnregisterEvent(_resolvedSource);
                _resolvedSource = newSource;
                if (_resolvedSource is not null) RegisterEvent(_resolvedSource);
            }
        }

        private void RegisterEvent(object source)
        {
            if (source is global::Avalonia.Xaml.Behaviors.SourceGenerators.UnitTests.TestControl typedSource)
            {
                _proxy = new EventProxy(this);
                typedSource.TestEvent += _proxy.OnEvent;
            }
        }

        private void UnregisterEvent(object source)
        {
            if (source is global::Avalonia.Xaml.Behaviors.SourceGenerators.UnitTests.TestControl typedSource && _proxy != null)
            {
                typedSource.TestEvent -= _proxy.OnEvent;
                _proxy = null;
            }
        }

        private void OnEvent(object? sender, global::Avalonia.Interactivity.RoutedEventArgs e)
        {
            Interaction.ExecuteActions(AssociatedObject, this.Actions, e);
        }

        private class EventProxy
        {
            private readonly WeakReference<TestEventTrigger> _trigger;

            public EventProxy(TestEventTrigger trigger)
            {
                _trigger = new WeakReference<TestEventTrigger>(trigger);
            }

            public void OnEvent(object? sender, global::Avalonia.Interactivity.RoutedEventArgs e)
            {
                if (_trigger.TryGetTarget(out var trigger))
                {
                    trigger.OnEvent(sender, e);
                }
                else
                {
                    if (sender is global::Avalonia.Xaml.Behaviors.SourceGenerators.UnitTests.TestControl typedSource)
                    {
                        typedSource.TestEvent -= OnEvent;
                    }
                }
            }
        }
    }
}
